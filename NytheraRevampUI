--[[
    Nythera V3 UI Library - Rewritten
    A clean, modular, and efficient UI library for Roblox
    Features: Tabs, Sections, Components, Notifications, Config Management
]]

--============================================--
--            SERVICES & VARIABLES            --
--============================================--

local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local MarketplaceService = game:GetService("MarketplaceService")

local LocalPlayer = Players.LocalPlayer
local GameId = game.PlaceId

-- Get game name for default config naming
local GameName = "Unknown"
pcall(function()
    local info = MarketplaceService:GetProductInfo(GameId)
    if info and info.Name then
        GameName = info.Name:gsub("[^%w]", ""):sub(1, 20) -- Clean and limit length
    end
end)

--============================================--
--               LIBRARY SETUP                --
--============================================--

local Library = {
    Config = {
        WindowName = "Nythera V3",
        Color = Color3.fromRGB(50, 50, 50),
        AccentColor = Color3.fromRGB(70, 130, 240)
    },
    Flags = {},
    Settings = {
        HideNotifications = false
    }
}

--============================================--
--            UTILITY FUNCTIONS               --
--============================================--

local function Create(className, properties, children)
    local instance = Instance.new(className)
    
    for property, value in pairs(properties or {}) do
        instance[property] = value
    end
    
    for _, child in pairs(children or {}) do
        child.Parent = instance
    end
    
    return instance
end

local function Tween(instance, duration, properties, style, direction)
    style = style or Enum.EasingStyle.Quad
    direction = direction or Enum.EasingDirection.Out
    local tween = TweenService:Create(instance, TweenInfo.new(duration, style, direction), properties)
    tween:Play()
    return tween
end

local function Debounce(cooldown)
    local debounced = false
    return function(callback)
        if debounced then return end
        debounced = true
        callback()
        task.delay(cooldown, function()
            debounced = false
        end)
    end
end

local function CleanString(str)
    return str:gsub("[^%w%-%_]", "")
end

local function GenerateFlag(name)
    if name then
        return name:gsub("[^%w]", "_"):lower()
    end
    return tostring(tick())
end

--============================================--
--           NOTIFICATION SYSTEM              --
--============================================--

local NotificationColors = {
    Error = {
        Background = Color3.fromRGB(45, 30, 30),
        Border = Color3.fromRGB(120, 50, 50),
        Text = Color3.fromRGB(255, 120, 120),
        Icon = "rbxassetid://7072725342"
    },
    Warning = {
        Background = Color3.fromRGB(45, 40, 25),
        Border = Color3.fromRGB(120, 100, 40),
        Text = Color3.fromRGB(255, 200, 100),
        Icon = "rbxassetid://1764960415"
    },
    Success = {
        Background = Color3.fromRGB(30, 45, 35),
        Border = Color3.fromRGB(50, 120, 70),
        Text = Color3.fromRGB(120, 255, 150),
        Icon = "rbxassetid://7072706620"
    }
}

local NotificationManager = {
    Container = nil,
    Notifications = {},
    Layout = nil
}

function NotificationManager:Initialize(parent)
    if self.Container then
        self.Container:Destroy()
    end
    
    self.Container = Create("Frame", {
        Name = "NotificationContainer",
        Parent = parent,
        BackgroundTransparency = 1,
        Position = UDim2.new(0.5, 0, 0, 35),
        Size = UDim2.new(0, 250, 0, 160),
        AnchorPoint = Vector2.new(0.5, 0),
        ZIndex = 100
    })
    
    self.Layout = Create("UIListLayout", {
        Parent = self.Container,
        SortOrder = Enum.SortOrder.LayoutOrder,
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        Padding = UDim.new(0, 4)
    })
    
    self.Notifications = {}
end

function NotificationManager:Show(messageType, message)
    -- Check if notifications are hidden
    if Library.Settings.HideNotifications then return end
    
    local colors = NotificationColors[messageType]
    if not colors or not self.Container then return end
    
    -- Check if notification with same message and type exists
    local existingKey = messageType .. "_" .. message
    if self.Notifications[existingKey] then
        local existing = self.Notifications[existingKey]
        existing.Count = existing.Count + 1
        existing.Label.Text = message .. " (" .. existing.Count .. "x)"
        
        -- Reset the dismiss timer
        if existing.DismissThread then
            task.cancel(existing.DismissThread)
        end
        existing.DismissThread = task.delay(3, function()
            self:Dismiss(existingKey)
        end)
        return
    end
    
    -- Create new notification (medium size)
    local NotifFrame = Create("Frame", {
        Name = "Notification_" .. messageType,
        Parent = self.Container,
        BackgroundColor3 = colors.Background,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 32),
        ZIndex = 101
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 5),
        Parent = NotifFrame
    })
    
    Create("UIStroke", {
        Parent = NotifFrame,
        Color = colors.Border,
        Thickness = 1,
        Transparency = 0.3
    })
    
    local Icon = Create("ImageLabel", {
        Name = "Icon",
        Parent = NotifFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0.5, -7),
        Size = UDim2.new(0, 14, 0, 14),
        Image = colors.Icon,
        ImageColor3 = colors.Text,
        ZIndex = 102
    })
    
    local Label = Create("TextLabel", {
        Name = "Label",
        Parent = NotifFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 28, 0, 0),
        Size = UDim2.new(1, -52, 1, 0),
        Font = Enum.Font.Gotham,
        Text = message,
        TextColor3 = colors.Text,
        TextSize = 12,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd,
        ZIndex = 102
    })
    
    local CloseButton = Create("TextButton", {
        Name = "Close",
        Parent = NotifFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -24, 0, 0),
        Size = UDim2.new(0, 24, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = "Ã—",
        TextColor3 = colors.Text,
        TextSize = 16,
        ZIndex = 102
    })
    
    -- Store notification data
    local notifData = {
        Frame = NotifFrame,
        Label = Label,
        Count = 1,
        DismissThread = nil
    }
    
    self.Notifications[existingKey] = notifData
    
    -- Close button handler
    CloseButton.MouseButton1Click:Connect(function()
        self:Dismiss(existingKey)
    end)
    
    -- Auto dismiss after 3 seconds
    notifData.DismissThread = task.delay(3, function()
        self:Dismiss(existingKey)
    end)
end

function NotificationManager:Dismiss(key)
    local notif = self.Notifications[key]
    if notif then
        if notif.DismissThread then
            pcall(function() task.cancel(notif.DismissThread) end)
        end
        if notif.Frame and notif.Frame.Parent then
            notif.Frame:Destroy()
        end
        self.Notifications[key] = nil
    end
end

-- Public notification functions
function Library:Notify(messageType, message)
    NotificationManager:Show(messageType, message)
end

function Library:NotifyError(message)
    self:Notify("Error", message)
end

function Library:NotifyWarning(message)
    self:Notify("Warning", message)
end

function Library:NotifySuccess(message)
    self:Notify("Success", message)
end

--============================================--
--            COMPONENT CREATORS              --
--============================================--

local Components = {}

-- Toggle Component
function Components.CreateToggle(parent, options, library)
    options = options or {}
    local name = options.Name or "Toggle"
    local default = options.Default or false
    local callback = options.Callback or function() end
    local flag = options.Flag or GenerateFlag(name)
    
    local toggled = default
    
    local ToggleFrame = Create("Frame", {
        Name = name .. "Toggle",
        Parent = parent,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 30)
    })
    
    local Title = Create("TextLabel", {
        Name = "Title",
        Parent = ToggleFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 0, 0, 0),
        Size = UDim2.new(1, -50, 1, 0),
        Font = Enum.Font.Gotham,
        Text = name,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd
    })
    
    local ToggleButton = Create("Frame", {
        Name = "Button",
        Parent = ToggleFrame,
        BackgroundColor3 = Color3.fromRGB(40, 40, 45),
        BorderSizePixel = 0,
        Position = UDim2.new(1, -40, 0.5, -10),
        Size = UDim2.new(0, 40, 0, 20)
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(1, 0),
        Parent = ToggleButton
    })
    
    local Circle = Create("Frame", {
        Name = "Circle",
        Parent = ToggleButton,
        BackgroundColor3 = Color3.fromRGB(255, 255, 255),
        BorderSizePixel = 0,
        Position = UDim2.new(0, 2, 0.5, -8),
        Size = UDim2.new(0, 16, 0, 16)
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(1, 0),
        Parent = Circle
    })
    
    local function SetToggle(state, skipCallback)
        toggled = state
        
        if toggled then
            Tween(ToggleButton, 0.2, {BackgroundColor3 = library.Config.AccentColor})
            Tween(Circle, 0.2, {Position = UDim2.new(1, -18, 0.5, -8)})
        else
            Tween(ToggleButton, 0.2, {BackgroundColor3 = Color3.fromRGB(40, 40, 45)})
            Tween(Circle, 0.2, {Position = UDim2.new(0, 2, 0.5, -8)})
        end
        
        if not skipCallback then
            callback(toggled)
        end
    end
    
    -- Initialize state
    if default then
        SetToggle(true, true)
    end
    
    -- Click handler
    local ClickButton = Create("TextButton", {
        Name = "ClickArea",
        Parent = ToggleFrame,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        Text = "",
        ZIndex = 10
    })
    
    local debounce = Debounce(0.2)
    ClickButton.MouseButton1Click:Connect(function()
        debounce(function()
            SetToggle(not toggled)
        end)
    end)
    
    -- Return functions
    local ToggleFunctions = {}
    
    function ToggleFunctions:Set(state)
        SetToggle(state)
    end
    
    function ToggleFunctions:GetValue()
        return toggled
    end
    
    library.Flags[flag] = ToggleFunctions
    return ToggleFunctions
end

-- Slider Component
function Components.CreateSlider(parent, options, library)
    options = options or {}
    local name = options.Name or "Slider"
    local min = options.Min or 0
    local max = options.Max or 100
    local default = options.Default or min
    local suffix = options.Suffix or ""
    local callback = options.Callback or function() end
    local flag = options.Flag or GenerateFlag(name)
    
    local value = default
    local sliding = false
    
    local SliderFrame = Create("Frame", {
        Name = name .. "Slider",
        Parent = parent,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 50)
    })
    
    local Title = Create("TextLabel", {
        Name = "Title",
        Parent = SliderFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 0, 0, 0),
        Size = UDim2.new(1, -50, 0, 20),
        Font = Enum.Font.Gotham,
        Text = name,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd
    })
    
    local ValueDisplay = Create("TextLabel", {
        Name = "Value",
        Parent = SliderFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -50, 0, 0),
        Size = UDim2.new(0, 50, 0, 20),
        Font = Enum.Font.Gotham,
        Text = tostring(default) .. suffix,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Right
    })
    
    local SliderBack = Create("Frame", {
        Name = "SliderBack",
        Parent = SliderFrame,
        BackgroundColor3 = Color3.fromRGB(40, 40, 45),
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 0, 25),
        Size = UDim2.new(1, 0, 0, 10)
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(1, 0),
        Parent = SliderBack
    })
    
    local SliderFill = Create("Frame", {
        Name = "Fill",
        Parent = SliderBack,
        BackgroundColor3 = library.Config.AccentColor,
        BorderSizePixel = 0,
        Size = UDim2.new((default - min) / (max - min), 0, 1, 0)
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(1, 0),
        Parent = SliderFill
    })
    
    local SliderButton = Create("TextButton", {
        Name = "SliderButton",
        Parent = SliderBack,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        Text = ""
    })
    
    local function UpdateSlider(newValue, skipCallback)
        value = math.clamp(newValue, min, max)
        local percent = (value - min) / (max - min)
        
        SliderFill.Size = UDim2.new(percent, 0, 1, 0)
        ValueDisplay.Text = tostring(math.floor(value * 100) / 100) .. suffix
        
        if not skipCallback then
            callback(value)
        end
    end
    
    -- Sliding logic
    local sliderConnection
    local inputEndedConnection
    
    local function StartSliding(input)
        sliding = true
        local relX = math.clamp((input.Position.X - SliderBack.AbsolutePosition.X) / SliderBack.AbsoluteSize.X, 0, 1)
        UpdateSlider(min + (relX * (max - min)))
        
        if sliderConnection then sliderConnection:Disconnect() end
        if inputEndedConnection then inputEndedConnection:Disconnect() end
        
        sliderConnection = UserInputService.InputChanged:Connect(function(changedInput)
            if sliding and (changedInput.UserInputType == Enum.UserInputType.MouseMovement or changedInput.UserInputType == Enum.UserInputType.Touch) then
                local relX = math.clamp((changedInput.Position.X - SliderBack.AbsolutePosition.X) / SliderBack.AbsoluteSize.X, 0, 1)
                UpdateSlider(min + (relX * (max - min)))
            end
        end)
        
        -- Only connect InputEnded while actively sliding
        inputEndedConnection = UserInputService.InputEnded:Connect(function(endedInput)
            if (endedInput.UserInputType == Enum.UserInputType.MouseButton1 or endedInput.UserInputType == Enum.UserInputType.Touch) and sliding then
                StopSliding()
            end
        end)
    end
    
    local function StopSliding()
        sliding = false
        if sliderConnection then
            sliderConnection:Disconnect()
            sliderConnection = nil
        end
        if inputEndedConnection then
            inputEndedConnection:Disconnect()
            inputEndedConnection = nil
        end
    end
    
    SliderButton.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            StartSliding(input)
        end
    end)
    
    SliderButton.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            StopSliding()
        end
    end)
    
    -- Initialize
    UpdateSlider(default, true)
    
    -- Return functions
    local SliderFunctions = {}
    
    function SliderFunctions:Set(newValue)
        UpdateSlider(newValue)
    end
    
    function SliderFunctions:GetValue()
        return value
    end
    
    library.Flags[flag] = SliderFunctions
    return SliderFunctions
end

-- Button Component
function Components.CreateButton(parent, options, library)
    options = options or {}
    local name = options.Name or "Button"
    local callback = options.Callback or function() end
    
    local ButtonFrame = Create("Frame", {
        Name = name .. "Button",
        Parent = parent,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 30)
    })
    
    local Button = Create("TextButton", {
        Name = "Button",
        Parent = ButtonFrame,
        BackgroundColor3 = Color3.fromRGB(40, 40, 45),
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 30),
        Font = Enum.Font.Gotham,
        Text = name,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 14,
        AutoButtonColor = false,
        TextTruncate = Enum.TextTruncate.AtEnd
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 6),
        Parent = Button
    })
    
    local debounce = Debounce(0.3)
    Button.MouseButton1Click:Connect(function()
        debounce(function()
            Tween(Button, 0.1, {BackgroundColor3 = library.Config.AccentColor})
            task.wait(0.1)
            Tween(Button, 0.1, {BackgroundColor3 = Color3.fromRGB(40, 40, 45)})
            callback()
        end)
    end)
    
    Button.MouseEnter:Connect(function()
        Tween(Button, 0.2, {BackgroundColor3 = Color3.fromRGB(50, 50, 55)})
    end)
    
    Button.MouseLeave:Connect(function()
        Tween(Button, 0.2, {BackgroundColor3 = Color3.fromRGB(40, 40, 45)})
    end)
end

-- Rectangular Toggle Button Component
function Components.CreateRectButton(parent, options, library)
    options = options or {}
    local name = options.Name or "Button"
    local default = options.Default or false
    local width = options.Width or 100
    local height = options.Height or 30
    local callback = options.Callback or function() end
    local flag = options.Flag or GenerateFlag(name)
    
    local active = default
    
    local ButtonFrame = Create("Frame", {
        Name = name .. "RectButton",
        Parent = parent,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, height)
    })
    
    local Button = Create("TextButton", {
        Name = "Button",
        Parent = ButtonFrame,
        BackgroundColor3 = Color3.fromRGB(40, 40, 45),
        BorderSizePixel = 0,
        Size = UDim2.new(0, width, 0, height),
        Font = Enum.Font.Gotham,
        Text = name,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 14,
        AutoButtonColor = false,
        TextTruncate = Enum.TextTruncate.AtEnd
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 6),
        Parent = Button
    })
    
    local function SetButton(state)
        active = state
        
        if active then
            Tween(Button, 0.2, {
                BackgroundColor3 = Color3.fromRGB(255, 255, 255),
                TextColor3 = Color3.fromRGB(30, 30, 35)
            })
        else
            Tween(Button, 0.2, {
                BackgroundColor3 = Color3.fromRGB(40, 40, 45),
                TextColor3 = Color3.fromRGB(255, 255, 255)
            })
        end
        
        callback(active)
    end
    
    -- Initialize
    if default then
        SetButton(true)
    end
    
    local debounce = Debounce(0.2)
    Button.MouseButton1Click:Connect(function()
        debounce(function()
            SetButton(not active)
        end)
    end)
    
    Button.MouseEnter:Connect(function()
        if not active then
            Tween(Button, 0.2, {BackgroundColor3 = Color3.fromRGB(50, 50, 55)})
        end
    end)
    
    Button.MouseLeave:Connect(function()
        if not active then
            Tween(Button, 0.2, {BackgroundColor3 = Color3.fromRGB(40, 40, 45)})
        end
    end)
    
    -- Return functions
    local ButtonFunctions = {}
    
    function ButtonFunctions:Set(state)
        SetButton(state)
    end
    
    function ButtonFunctions:GetValue()
        return active
    end
    
    library.Flags[flag] = ButtonFunctions
    return ButtonFunctions
end

-- Text Input Component
function Components.CreateInputLetterAdd(parent, options, library)
    options = options or {}
    local name = options.Name or "Input"
    local default = options.Default or ""
    local placeholder = options.PlaceholderText or "Type here..."
    local maxLength = options.MaxLength or 100
    local callback = options.Callback or function() end
    local flag = options.Flag or GenerateFlag(name)
    
    local InputFrame = Create("Frame", {
        Name = name .. "Input",
        Parent = parent,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 50)
    })
    
    local Title = Create("TextLabel", {
        Name = "Title",
        Parent = InputFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 0, 0, 0),
        Size = UDim2.new(1, 0, 0, 20),
        Font = Enum.Font.Gotham,
        Text = name,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd
    })
    
    local InputBox = Create("Frame", {
        Name = "InputBox",
        Parent = InputFrame,
        BackgroundColor3 = Color3.fromRGB(40, 40, 45),
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 0, 25),
        Size = UDim2.new(1, 0, 0, 30)
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 6),
        Parent = InputBox
    })
    
    local TextBox = Create("TextBox", {
        Name = "TextBox",
        Parent = InputBox,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 10, 0, 0),
        Size = UDim2.new(1, -20, 1, 0),
        Font = Enum.Font.Gotham,
        Text = default,
        PlaceholderText = placeholder,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        PlaceholderColor3 = Color3.fromRGB(180, 180, 180),
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false,
        ClipsDescendants = true
    })
    
    TextBox.FocusLost:Connect(function()
        if maxLength and #TextBox.Text > maxLength then
            TextBox.Text = string.sub(TextBox.Text, 1, maxLength)
        end
        callback(TextBox.Text)
    end)
    
    TextBox:GetPropertyChangedSignal("Text"):Connect(function()
        if maxLength and #TextBox.Text > maxLength then
            TextBox.Text = string.sub(TextBox.Text, 1, maxLength)
        end
    end)
    
    InputBox.MouseEnter:Connect(function()
        Tween(InputBox, 0.2, {BackgroundColor3 = Color3.fromRGB(50, 50, 55)})
    end)
    
    InputBox.MouseLeave:Connect(function()
        Tween(InputBox, 0.2, {BackgroundColor3 = Color3.fromRGB(40, 40, 45)})
    end)
    
    TextBox.Focused:Connect(function()
        Tween(InputBox, 0.2, {BackgroundColor3 = Color3.fromRGB(60, 60, 65)})
    end)
    
    TextBox.FocusLost:Connect(function()
        Tween(InputBox, 0.2, {BackgroundColor3 = Color3.fromRGB(40, 40, 45)})
    end)
    
    -- Return functions
    local InputFunctions = {}
    
    function InputFunctions:Set(text)
        TextBox.Text = tostring(text)
        callback(TextBox.Text)
    end
    
    function InputFunctions:GetValue()
        return TextBox.Text
    end
    
    library.Flags[flag] = InputFunctions
    return InputFunctions
end

-- Combo Input Component (Text + Number + Toggle)
function Components.CreateInput(parent, options, library)
    options = options or {}
    local name = options.Name or "Input"
    local default = options.Default or ""
    local numberValue = options.DefaultNumber or 0
    local minValue = options.MinValue or 0
    local maxValue = options.MaxValue or 100
    local callback = options.Callback or function() end
    local flag = options.Flag or GenerateFlag(name)
    
    local active = false
    
    local InputFrame = Create("Frame", {
        Name = name .. "ComboInput",
        Parent = parent,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 50)
    })
    
    local Title = Create("TextLabel", {
        Name = "Title",
        Parent = InputFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 0, 0, 0),
        Size = UDim2.new(0.5, 0, 0, 20),
        Font = Enum.Font.Gotham,
        Text = name,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd
    })
    
    local InputBox = Create("Frame", {
        Name = "InputBox",
        Parent = InputFrame,
        BackgroundColor3 = Color3.fromRGB(40, 40, 45),
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 0, 25),
        Size = UDim2.new(1, 0, 0, 30)
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 6),
        Parent = InputBox
    })
    
    local FixedText = Create("TextLabel", {
        Name = "FixedText",
        Parent = InputBox,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 10, 0, 0),
        Size = UDim2.new(1, -140, 1, 0),
        Font = Enum.Font.Gotham,
        Text = default,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd
    })
    
    local NumberInputBox = Create("Frame", {
        Name = "NumberInput",
        Parent = InputBox,
        BackgroundColor3 = Color3.fromRGB(50, 50, 55),
        BorderSizePixel = 0,
        Position = UDim2.new(1, -120, 0.5, -12),
        Size = UDim2.new(0, 80, 0, 24),
        ZIndex = 2
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 4),
        Parent = NumberInputBox
    })
    
    local NumberBox = Create("TextBox", {
        Name = "NumberBox",
        Parent = NumberInputBox,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 5, 0, 0),
        Size = UDim2.new(1, -10, 1, 0),
        Font = Enum.Font.Gotham,
        Text = tostring(numberValue),
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Center,
        ClearTextOnFocus = false,
        ZIndex = 3
    })
    
    local ToggleIndicator = Create("Frame", {
        Name = "ToggleIndicator",
        Parent = InputBox,
        BackgroundColor3 = Color3.fromRGB(50, 50, 55),
        BorderSizePixel = 0,
        Position = UDim2.new(1, -30, 0.5, -10),
        Size = UDim2.new(0, 20, 0, 20)
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(1, 0),
        Parent = ToggleIndicator
    })
    
    -- Toggle indicator click
    ToggleIndicator.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            active = not active
            if active then
                Tween(ToggleIndicator, 0.2, {BackgroundColor3 = Color3.fromRGB(255, 255, 255)})
            else
                Tween(ToggleIndicator, 0.2, {BackgroundColor3 = Color3.fromRGB(50, 50, 55)})
            end
            callback(FixedText.Text, tonumber(NumberBox.Text) or numberValue, active)
        end
    end)
    
    NumberBox.FocusLost:Connect(function()
        local inputValue = tonumber(NumberBox.Text) or numberValue
        inputValue = math.clamp(inputValue, minValue, maxValue)
        NumberBox.Text = tostring(inputValue)
        callback(FixedText.Text, inputValue, active)
    end)
    
    -- Return functions
    local InputFunctions = {}
    
    function InputFunctions:SetFixedText(text)
        FixedText.Text = text
        callback(text, tonumber(NumberBox.Text) or numberValue, active)
    end
    
    function InputFunctions:SetNumber(number)
        local value = math.clamp(number, minValue, maxValue)
        NumberBox.Text = tostring(value)
        callback(FixedText.Text, value, active)
    end
    
    function InputFunctions:SetActive(state)
        active = state
        if active then
            ToggleIndicator.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        else
            ToggleIndicator.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
        end
        callback(FixedText.Text, tonumber(NumberBox.Text) or numberValue, active)
    end
    
    function InputFunctions:GetValue()
        return {
            text = FixedText.Text,
            number = tonumber(NumberBox.Text) or numberValue,
            active = active
        }
    end
    
    function InputFunctions:Set(value)
        if type(value) == "table" then
            if value.text then self:SetFixedText(value.text) end
            if value.number then self:SetNumber(value.number) end
            if value.active ~= nil then self:SetActive(value.active) end
        else
            self:SetFixedText(tostring(value))
        end
    end
    
    library.Flags[flag] = InputFunctions
    return InputFunctions
end

-- Dropdown Component (Single and Multi Select with Search) - FIXED ANIMATIONS
function Components.CreateDropdown(parent, options, library)
    options = options or {}
    local name = options.Name or "Dropdown"
    local items = options.Items or {}
    local multiSelect = options.MultiSelect or false
    local maxSelections = options.MaxSelections or #items
    local defaultSelections = options.DefaultSelections or {}
    local callback = options.Callback or function() end
    local flag = options.Flag or GenerateFlag(name)
    local autoClose = options.AutoClose ~= false -- Default true, set false to disable
    
    local selectedItems = {}
    local dropped = false
    local connections = {}
    local dropdownDebounce = false
    local searchText = ""
    local showSearch = #items > 5
    
    -- Initialize selections
    if multiSelect then
        for _, v in ipairs(defaultSelections) do
            selectedItems[v] = true
        end
    else
        if #defaultSelections > 0 then
            selectedItems[defaultSelections[1]] = true
        end
    end
    
    local DropdownFrame = Create("Frame", {
        Name = name .. "Dropdown",
        Parent = parent,
        BackgroundColor3 = Color3.fromRGB(35, 35, 40),
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 35),
        ClipsDescendants = false,
        ZIndex = 2
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 6),
        Parent = DropdownFrame
    })
    
    local HeaderFrame = Create("Frame", {
        Name = "Header",
        Parent = DropdownFrame,
        BackgroundColor3 = Color3.fromRGB(35, 35, 40),
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 35),
        ZIndex = 3
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 6),
        Parent = HeaderFrame
    })
    
    local BottomCover = Create("Frame", {
        Name = "BottomCover",
        Parent = HeaderFrame,
        BackgroundColor3 = Color3.fromRGB(35, 35, 40),
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 1, -6),
        Size = UDim2.new(1, 0, 0, 6),
        Visible = false,
        ZIndex = 3
    })
    
    local HeaderButton = Create("TextButton", {
        Name = "HeaderButton",
        Parent = HeaderFrame,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        Text = "",
        ZIndex = 5
    })
    
    local DropdownTitle = Create("TextLabel", {
        Name = "Title",
        Parent = HeaderFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 10, 0, 0),
        Size = UDim2.new(1, -40, 1, 0),
        Font = Enum.Font.Gotham,
        Text = name,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd,
        ZIndex = 4
    })
    
    local ArrowIcon = Create("ImageLabel", {
        Name = "Arrow",
        Parent = HeaderFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -20, 0.5, -5),
        Size = UDim2.new(0, 10, 0, 10),
        Image = "rbxassetid://6031094670",
        ImageColor3 = Color3.fromRGB(255, 255, 255),
        Rotation = 90,
        ZIndex = 4
    })
    
    local DropContent = Create("Frame", {
        Name = "DropContent",
        Parent = DropdownFrame,
        BackgroundColor3 = Color3.fromRGB(40, 40, 45),
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 0, 35),
        Size = UDim2.new(1, 0, 0, 0),
        ClipsDescendants = true,
        ZIndex = 3
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 6),
        Parent = DropContent
    })
    
    -- Search bar (only if more than 5 items)
    local SearchBox = nil
    local SearchContainer = nil
    
    if showSearch then
        SearchContainer = Create("Frame", {
            Name = "SearchContainer",
            Parent = DropContent,
            BackgroundColor3 = Color3.fromRGB(50, 50, 55),
            BorderSizePixel = 0,
            Position = UDim2.new(0, 5, 0, 5),
            Size = UDim2.new(1, -10, 0, 25),
            ZIndex = 5
        })
        
        Create("UICorner", {
            CornerRadius = UDim.new(0, 4),
            Parent = SearchContainer
        })
        
        SearchBox = Create("TextBox", {
            Name = "SearchBox",
            Parent = SearchContainer,
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 8, 0, 0),
            Size = UDim2.new(1, -16, 1, 0),
            Font = Enum.Font.Gotham,
            Text = "",
            PlaceholderText = "Search...",
            TextColor3 = Color3.fromRGB(255, 255, 255),
            PlaceholderColor3 = Color3.fromRGB(150, 150, 150),
            TextSize = 12,
            TextXAlignment = Enum.TextXAlignment.Left,
            ClearTextOnFocus = false,
            ZIndex = 6
        })
    end
    
    local ItemsFrame = Create("ScrollingFrame", {
        Name = "ItemsFrame",
        Parent = DropContent,
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Position = showSearch and UDim2.new(0, 0, 0, 35) or UDim2.new(0, 0, 0, 0),
        Size = showSearch and UDim2.new(1, 0, 1, -35) or UDim2.new(1, 0, 1, 0),
        CanvasSize = UDim2.new(0, 0, 0, 0),
        ScrollBarThickness = 2,
        ScrollBarImageColor3 = Color3.fromRGB(255, 255, 255),
        ScrollBarImageTransparency = 0.8,
        AutomaticCanvasSize = Enum.AutomaticSize.Y,
        ZIndex = 4
    })
    
    Create("UIListLayout", {
        Parent = ItemsFrame,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 4)
    })
    
    Create("UIPadding", {
        Parent = ItemsFrame,
        PaddingTop = UDim.new(0, 5),
        PaddingBottom = UDim.new(0, 5),
        PaddingLeft = UDim.new(0, 5),
        PaddingRight = UDim.new(0, 5)
    })
    
    local function UpdateDisplayText()
        local selectedNames = {}
        for item, _ in pairs(selectedItems) do
            table.insert(selectedNames, item)
        end
        
        if #selectedNames == 0 then
            DropdownTitle.Text = name
        elseif not multiSelect then
            DropdownTitle.Text = name .. ": " .. selectedNames[1]
        elseif #selectedNames == 1 then
            DropdownTitle.Text = name .. ": " .. selectedNames[1]
        else
            DropdownTitle.Text = name .. " (" .. #selectedNames .. " selected)"
        end
        
        if multiSelect then
            callback(selectedNames)
        else
            callback(selectedNames[1] or nil)
        end
    end
    
    local function CalculateContentHeight()
        local itemHeight = 25
        local padding = 4
        local totalPadding = 10
        local searchHeight = showSearch and 35 or 0
        
        -- Count visible items based on search
        local visibleCount = 0
        for _, item in ipairs(items) do
            if searchText == "" or string.find(string.lower(item), string.lower(searchText)) then
                visibleCount = visibleCount + 1
            end
        end
        
        local visibleItems = math.min(visibleCount, 6)
        if visibleItems == 0 then return searchHeight + 10 end
        
        return (visibleItems * itemHeight) + ((visibleItems - 1) * padding) + totalPadding + searchHeight
    end
    
    local function CreateDropdownItems()
        -- Clear existing items
        for _, child in pairs(ItemsFrame:GetChildren()) do
            if child:IsA("TextButton") then
                child:Destroy()
            end
        end
        
        local layoutOrder = 0
        for _, item in ipairs(items) do
            -- Filter by search
            local visible = searchText == "" or string.find(string.lower(item), string.lower(searchText))
            
            if visible then
                layoutOrder = layoutOrder + 1
                
                local ItemButton = Create("TextButton", {
                    Name = item .. "Item",
                    Parent = ItemsFrame,
                    BackgroundColor3 = Color3.fromRGB(45, 45, 50),
                    BackgroundTransparency = 0.9,
                    Size = UDim2.new(1, -4, 0, 25),
                    Font = Enum.Font.Gotham,
                    Text = "",
                    ZIndex = 5,
                    LayoutOrder = layoutOrder
                })
                
                Create("UICorner", {
                    CornerRadius = UDim.new(0, 4),
                    Parent = ItemButton
                })
                
                local ItemText = Create("TextLabel", {
                    Name = "ItemText",
                    Parent = ItemButton,
                    BackgroundTransparency = 1,
                    Position = UDim2.new(0, 5, 0, 0),
                    Size = UDim2.new(1, multiSelect and -30 or -10, 1, 0),
                    Font = Enum.Font.Gotham,
                    Text = item,
                    TextColor3 = Color3.fromRGB(255, 255, 255),
                    TextSize = 14,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    TextTruncate = Enum.TextTruncate.AtEnd,
                    ZIndex = 5
                })
                
                if multiSelect then
                    local SelectionBox = Create("Frame", {
                        Name = "SelectionBox",
                        Parent = ItemButton,
                        BackgroundColor3 = selectedItems[item] and library.Config.AccentColor or Color3.fromRGB(50, 50, 55),
                        BorderSizePixel = 0,
                        Position = UDim2.new(1, -25, 0.5, -7),
                        Size = UDim2.new(0, 14, 0, 14),
                        ZIndex = 6
                    })
                    
                    Create("UICorner", {
                        CornerRadius = UDim.new(0, 3),
                        Parent = SelectionBox
                    })
                    
                    local SelectionCheck = Create("ImageLabel", {
                        Name = "Check",
                        Parent = SelectionBox,
                        BackgroundTransparency = 1,
                        Position = UDim2.new(0, 2, 0, 2),
                        Size = UDim2.new(1, -4, 1, -4),
                        Image = "rbxassetid://7072706620",
                        ImageColor3 = Color3.fromRGB(255, 255, 255),
                        ImageTransparency = selectedItems[item] and 0 or 1,
                        ZIndex = 6
                    })
                    
                    local itemDebounce = Debounce(0.15)
                    ItemButton.MouseButton1Click:Connect(function()
                        itemDebounce(function()
                            local currentCount = 0
                            for _, _ in pairs(selectedItems) do
                                currentCount = currentCount + 1
                            end
                            
                            if selectedItems[item] then
                                selectedItems[item] = nil
                                Tween(SelectionBox, 0.15, {BackgroundColor3 = Color3.fromRGB(50, 50, 55)})
                                Tween(SelectionCheck, 0.15, {ImageTransparency = 1})
                            else
                                if currentCount < maxSelections then
                                    selectedItems[item] = true
                                    Tween(SelectionBox, 0.15, {BackgroundColor3 = library.Config.AccentColor})
                                    Tween(SelectionCheck, 0.15, {ImageTransparency = 0})
                                end
                            end
                            
                            UpdateDisplayText()
                        end)
                    end)
                else
                    if selectedItems[item] then
                        ItemButton.BackgroundTransparency = 0.7
                        ItemButton.BackgroundColor3 = library.Config.AccentColor
                    end
                    
                    local itemDebounce = Debounce(0.2)
                    ItemButton.MouseButton1Click:Connect(function()
                        itemDebounce(function()
                            for _, child in pairs(ItemsFrame:GetChildren()) do
                                if child:IsA("TextButton") then
                                    child.BackgroundTransparency = 0.9
                                    child.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
                                end
                            end
                            
                            ItemButton.BackgroundTransparency = 0.7
                            ItemButton.BackgroundColor3 = library.Config.AccentColor
                            
                            for k, _ in pairs(selectedItems) do
                                selectedItems[k] = nil
                            end
                            selectedItems[item] = true
                            
                            UpdateDisplayText()
                            
                            -- Only auto-close if autoClose is enabled
                            if autoClose then
                                task.wait(0.1)
                                ToggleDropdown()
                            end
                        end)
                    end)
                end
                
                ItemButton.MouseEnter:Connect(function()
                    if not (not multiSelect and selectedItems[item]) then
                        ItemButton.BackgroundTransparency = 0.5
                    end
                end)
                
                ItemButton.MouseLeave:Connect(function()
                    if not (not multiSelect and selectedItems[item]) then
                        ItemButton.BackgroundTransparency = 0.9
                    end
                end)
            end
        end
    end
    
    function ToggleDropdown()
        if dropdownDebounce then 
            return 
        end
        dropdownDebounce = true
        dropped = not dropped
        
        if dropped then
            BottomCover.Visible = true
            searchText = ""
            if SearchBox then SearchBox.Text = "" end
            CreateDropdownItems()
            
            local contentHeight = CalculateContentHeight()
            
            -- Animate opening
            Tween(ArrowIcon, 0.2, {Rotation = -90})
            Tween(DropContent, 0.2, {Size = UDim2.new(1, 0, 0, contentHeight)})
            Tween(DropdownFrame, 0.2, {Size = UDim2.new(1, 0, 0, 35 + contentHeight)})
            
            if connections.outsideClick then
                connections.outsideClick:Disconnect()
                connections.outsideClick = nil
            end
            
            -- Only register outside click handler if autoClose is enabled
            if autoClose then
                task.delay(0.3, function() -- Delay to prevent immediate close
                    if not dropped then return end -- Check if still open
                    
                    connections.outsideClick = UserInputService.InputBegan:Connect(function(input)
                        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                            if dropdownDebounce or not dropped then return end
                            
                            task.defer(function()
                                if not dropped then return end
                                
                                local inputPos = input.UserInputType == Enum.UserInputType.Touch and input.Position or UserInputService:GetMouseLocation()
                                local dropdownPos = DropdownFrame.AbsolutePosition
                                local dropdownSize = DropdownFrame.AbsoluteSize
                                
                                if inputPos.X < dropdownPos.X or inputPos.Y < dropdownPos.Y or
                                   inputPos.X > dropdownPos.X + dropdownSize.X or inputPos.Y > dropdownPos.Y + dropdownSize.Y then
                                    ToggleDropdown()
                                end
                            end)
                        end
                    end)
                end)
            end
        else
            Tween(ArrowIcon, 0.2, {Rotation = 90})
            Tween(DropContent, 0.2, {Size = UDim2.new(1, 0, 0, 0)})
            Tween(DropdownFrame, 0.2, {Size = UDim2.new(1, 0, 0, 35)})
            
            task.delay(0.2, function()
                BottomCover.Visible = false
                if connections.outsideClick then
                    connections.outsideClick:Disconnect()
                    connections.outsideClick = nil
                end
            end)
        end
        
        task.delay(0.3, function()
            dropdownDebounce = false
        end)
    end
    
    -- Search functionality
    if SearchBox then
        SearchBox:GetPropertyChangedSignal("Text"):Connect(function()
            searchText = SearchBox.Text
            CreateDropdownItems()
            
            local contentHeight = CalculateContentHeight()
            DropContent.Size = UDim2.new(1, 0, 0, contentHeight)
            DropdownFrame.Size = UDim2.new(1, 0, 0, 35 + contentHeight)
        end)
    end
    
    HeaderButton.MouseButton1Click:Connect(ToggleDropdown)
    
    CreateDropdownItems()
    UpdateDisplayText()
    
    -- Return functions
    local DropdownFunctions = {}
    
    function DropdownFunctions:Refresh(newItems)
        if not newItems or type(newItems) ~= "table" then return self end
        
        items = newItems
        showSearch = #items > 5
        
        -- If dropdown is open, close it first WITHOUT toggling
        if dropped then
            dropped = false
            dropdownDebounce = true
            
            ArrowIcon.Rotation = 90
            DropContent.Size = UDim2.new(1, 0, 0, 0)
            DropdownFrame.Size = UDim2.new(1, 0, 0, 35)
            BottomCover.Visible = false
            
            if connections.outsideClick then
                connections.outsideClick:Disconnect()
                connections.outsideClick = nil
            end
            
            task.delay(0.1, function()
                dropdownDebounce = false
            end)
        end
        
        -- Update search container visibility
        if SearchContainer then
            SearchContainer.Visible = showSearch
            ItemsFrame.Position = showSearch and UDim2.new(0, 0, 0, 35) or UDim2.new(0, 0, 0, 0)
            ItemsFrame.Size = showSearch and UDim2.new(1, 0, 1, -35) or UDim2.new(1, 0, 1, 0)
        end
        
        local validSelections = {}
        for item, _ in pairs(selectedItems) do
            for _, newItem in ipairs(items) do
                if newItem == item then
                    validSelections[item] = true
                    break
                end
            end
        end
        selectedItems = validSelections
        
        CreateDropdownItems()
        UpdateDisplayText()
        
        return self
    end
    
    function DropdownFunctions:Select(itemsToSelect, clear)
        if clear then selectedItems = {} end
        
        if type(itemsToSelect) == "string" then
            itemsToSelect = {itemsToSelect}
        end
        
        for _, item in ipairs(itemsToSelect) do
            for _, existingItem in ipairs(items) do
                if existingItem == item then
                    if multiSelect then
                        local currentCount = 0
                        for _, _ in pairs(selectedItems) do
                            currentCount = currentCount + 1
                        end
                        if currentCount < maxSelections then
                            selectedItems[item] = true
                        end
                    else
                        selectedItems = {}
                        selectedItems[item] = true
                        break
                    end
                    break
                end
            end
        end
        
        CreateDropdownItems()
        UpdateDisplayText()
        return self
    end
    
    function DropdownFunctions:GetValue()
        if multiSelect then
            local selectedNames = {}
            for item, _ in pairs(selectedItems) do
                table.insert(selectedNames, item)
            end
            return selectedNames
        else
            for item, _ in pairs(selectedItems) do
                return item
            end
            return nil
        end
    end
    
    function DropdownFunctions:Set(value)
        self:Select(value, true)
        return self
    end
    
    function DropdownFunctions:Destroy()
        for _, connection in pairs(connections) do
            if connection then connection:Disconnect() end
        end
        if DropdownFrame and DropdownFrame.Parent then
            DropdownFrame:Destroy()
        end
    end
    
    library.Flags[flag] = DropdownFunctions
    return DropdownFunctions
end
-- Input Multi Dropdown Component (with title and search) - FIXED ANIMATIONS
function Components.CreateInputMultiDropdown(parent, options, library)
    options = options or {}
    local name = options.Name or "Input Multi Dropdown"
    local items = options.Items or {}
    local placeholder = options.PlaceholderText or "No items available"
    local maxSelections = options.MaxSelections or #items
    local callback = options.Callback or function() end
    local flag = options.Flag or GenerateFlag(name)
    
    local selectedItems = {}
    local isExpanded = false
    local dropdownDebounce = false
    local searchText = ""
    local showSearch = #items > 5
    
    local DropdownFrame = Create("Frame", {
        Name = name .. "InputMultiDropdown",
        Parent = parent,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 70)
    })
    
    local Title = Create("TextLabel", {
        Name = "Title",
        Parent = DropdownFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 0, 0, 0),
        Size = UDim2.new(1, 0, 0, 20),
        Font = Enum.Font.Gotham,
        Text = name,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd
    })
    
    local DropdownContainer = Create("Frame", {
        Name = "DropdownContainer",
        Parent = DropdownFrame,
        BackgroundColor3 = Color3.fromRGB(35, 35, 40),
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 0, 25),
        Size = UDim2.new(1, 0, 0, 35),
        ClipsDescendants = false,
        ZIndex = 2
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 6),
        Parent = DropdownContainer
    })
    
    local HeaderFrame = Create("Frame", {
        Name = "Header",
        Parent = DropdownContainer,
        BackgroundColor3 = Color3.fromRGB(35, 35, 40),
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 35),
        ZIndex = 3
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 6),
        Parent = HeaderFrame
    })
    
    local HeaderButton = Create("TextButton", {
        Name = "HeaderButton",
        Parent = HeaderFrame,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        Text = "",
        ZIndex = 5
    })
    
    local DisplayText = Create("TextLabel", {
        Name = "DisplayText",
        Parent = HeaderFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 10, 0, 0),
        Size = UDim2.new(1, -40, 1, 0),
        Font = Enum.Font.Gotham,
        Text = placeholder,
        TextColor3 = Color3.fromRGB(180, 180, 180),
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd,
        ZIndex = 4
    })
    
    local ArrowIcon = Create("ImageLabel", {
        Name = "Arrow",
        Parent = HeaderFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -20, 0.5, -5),
        Size = UDim2.new(0, 10, 0, 10),
        Image = "rbxassetid://6031094670",
        ImageColor3 = Color3.fromRGB(255, 255, 255),
        Rotation = 90,
        ZIndex = 4
    })
    
    local ItemsContainer = Create("Frame", {
        Name = "ItemsContainer",
        Parent = DropdownContainer,
        BackgroundColor3 = Color3.fromRGB(40, 40, 45),
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 0, 35),
        Size = UDim2.new(1, 0, 0, 0),
        ClipsDescendants = true,
        ZIndex = 3
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 6),
        Parent = ItemsContainer
    })
    
    -- Search container
    local SearchContainer = nil
    local SearchBox = nil
    
    if showSearch then
        SearchContainer = Create("Frame", {
            Name = "SearchContainer",
            Parent = ItemsContainer,
            BackgroundColor3 = Color3.fromRGB(50, 50, 55),
            BorderSizePixel = 0,
            Position = UDim2.new(0, 5, 0, 5),
            Size = UDim2.new(1, -10, 0, 25),
            ZIndex = 5
        })
        
        Create("UICorner", {
            CornerRadius = UDim.new(0, 4),
            Parent = SearchContainer
        })
        
        SearchBox = Create("TextBox", {
            Name = "SearchBox",
            Parent = SearchContainer,
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 8, 0, 0),
            Size = UDim2.new(1, -16, 1, 0),
            Font = Enum.Font.Gotham,
            Text = "",
            PlaceholderText = "Search...",
            TextColor3 = Color3.fromRGB(255, 255, 255),
            PlaceholderColor3 = Color3.fromRGB(150, 150, 150),
            TextSize = 12,
            TextXAlignment = Enum.TextXAlignment.Left,
            ClearTextOnFocus = false,
            ZIndex = 6
        })
    end
    
    local ItemsScrollFrame = Create("ScrollingFrame", {
        Name = "ItemsScrollFrame",
        Parent = ItemsContainer,
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Position = showSearch and UDim2.new(0, 0, 0, 35) or UDim2.new(0, 0, 0, 0),
        Size = showSearch and UDim2.new(1, 0, 1, -35) or UDim2.new(1, 0, 1, 0),
        CanvasSize = UDim2.new(0, 0, 0, 0),
        ScrollBarThickness = 2,
        ScrollBarImageColor3 = Color3.fromRGB(255, 255, 255),
        ScrollBarImageTransparency = 0.8,
        AutomaticCanvasSize = Enum.AutomaticSize.Y,
        ZIndex = 4
    })
    
    Create("UIListLayout", {
        Parent = ItemsScrollFrame,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 2)
    })
    
    Create("UIPadding", {
        Parent = ItemsScrollFrame,
        PaddingTop = UDim.new(0, 5),
        PaddingBottom = UDim.new(0, 5),
        PaddingLeft = UDim.new(0, 5),
        PaddingRight = UDim.new(0, 5)
    })
    
    local function UpdateDisplayText()
        local selectedCount = 0
        local selectedNames = {}
        
        for item, selected in pairs(selectedItems) do
            if selected then
                selectedCount = selectedCount + 1
                table.insert(selectedNames, item)
            end
        end
        
        if selectedCount == 0 then
            DisplayText.Text = placeholder
            DisplayText.TextColor3 = Color3.fromRGB(180, 180, 180)
        elseif selectedCount == 1 then
            DisplayText.Text = selectedNames[1]
            DisplayText.TextColor3 = Color3.fromRGB(255, 255, 255)
        else
            DisplayText.Text = selectedCount .. " items selected"
            DisplayText.TextColor3 = Color3.fromRGB(255, 255, 255)
        end
        
        pcall(function() callback(selectedNames) end)
    end
    
    local function CreateItems()
        for _, child in pairs(ItemsScrollFrame:GetChildren()) do
            if child:IsA("TextButton") then
                child:Destroy()
            end
        end
        
        local layoutOrder = 0
        for _, item in ipairs(items) do
            local visible = searchText == "" or string.find(string.lower(item), string.lower(searchText))
            
            if visible then
                layoutOrder = layoutOrder + 1
                
                local ItemButton = Create("TextButton", {
                    Name = item .. "Item",
                    Parent = ItemsScrollFrame,
                    BackgroundColor3 = Color3.fromRGB(45, 45, 50),
                    BackgroundTransparency = 0.9,
                    Size = UDim2.new(1, -4, 0, 25),
                    Text = "",
                    ZIndex = 5,
                    LayoutOrder = layoutOrder
                })
                
                Create("UICorner", {
                    CornerRadius = UDim.new(0, 4),
                    Parent = ItemButton
                })
                
                Create("TextLabel", {
                    Name = "ItemText",
                    Parent = ItemButton,
                    BackgroundTransparency = 1,
                    Position = UDim2.new(0, 5, 0, 0),
                    Size = UDim2.new(1, -30, 1, 0),
                    Font = Enum.Font.Gotham,
                    Text = item,
                    TextColor3 = Color3.fromRGB(255, 255, 255),
                    TextSize = 14,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    TextTruncate = Enum.TextTruncate.AtEnd,
                    ZIndex = 5
                })
                
                local SelectionBox = Create("Frame", {
                    Name = "SelectionBox",
                    Parent = ItemButton,
                    BackgroundColor3 = selectedItems[item] and library.Config.AccentColor or Color3.fromRGB(50, 50, 55),
                    BorderSizePixel = 0,
                    Position = UDim2.new(1, -22, 0.5, -6),
                    Size = UDim2.new(0, 12, 0, 12),
                    ZIndex = 6
                })
                
                Create("UICorner", {
                    CornerRadius = UDim.new(0, 2),
                    Parent = SelectionBox
                })
                
                local SelectionCheck = Create("ImageLabel", {
                    Name = "Check",
                    Parent = SelectionBox,
                    BackgroundTransparency = 1,
                    Position = UDim2.new(0, 1, 0, 1),
                    Size = UDim2.new(1, -2, 1, -2),
                    Image = "rbxassetid://7072706620",
                    ImageColor3 = Color3.fromRGB(255, 255, 255),
                    ImageTransparency = selectedItems[item] and 0 or 1,
                    ZIndex = 6
                })
                
                ItemButton.MouseButton1Click:Connect(function()
                    local currentCount = 0
                    for _, selected in pairs(selectedItems) do
                        if selected then currentCount = currentCount + 1 end
                    end
                    
                    if selectedItems[item] then
                        selectedItems[item] = false
                        Tween(SelectionBox, 0.15, {BackgroundColor3 = Color3.fromRGB(50, 50, 55)})
                        Tween(SelectionCheck, 0.15, {ImageTransparency = 1})
                    else
                        if currentCount < maxSelections then
                            selectedItems[item] = true
                            Tween(SelectionBox, 0.15, {BackgroundColor3 = library.Config.AccentColor})
                            Tween(SelectionCheck, 0.15, {ImageTransparency = 0})
                        end
                    end
                    
                    UpdateDisplayText()
                end)
                
                ItemButton.MouseEnter:Connect(function()
                    ItemButton.BackgroundTransparency = 0.6
                end)
                
                ItemButton.MouseLeave:Connect(function()
                    ItemButton.BackgroundTransparency = 0.9
                end)
            end
        end
    end
    
    local function CalculateContentHeight()
        local searchHeight = showSearch and 35 or 0
        local visibleCount = 0
        
        for _, item in ipairs(items) do
            if searchText == "" or string.find(string.lower(item), string.lower(searchText)) then
                visibleCount = visibleCount + 1
            end
        end
        
        local visibleItems = math.min(visibleCount, 6)
        if visibleItems == 0 then return searchHeight + 10 end
        
        return (visibleItems * 25) + ((visibleItems - 1) * 2) + 10 + searchHeight
    end
    
    local function ToggleDropdown()
        if dropdownDebounce then return end
        dropdownDebounce = true
        
        isExpanded = not isExpanded
        
        if isExpanded then
            searchText = ""
            if SearchBox then SearchBox.Text = "" end
            CreateItems()
            
            local contentHeight = CalculateContentHeight()
            
            Tween(ArrowIcon, 0.2, {Rotation = -90})
            Tween(ItemsContainer, 0.2, {Size = UDim2.new(1, 0, 0, contentHeight)})
            Tween(DropdownFrame, 0.2, {Size = UDim2.new(1, 0, 0, 70 + contentHeight)})
        else
            Tween(ArrowIcon, 0.2, {Rotation = 90})
            Tween(ItemsContainer, 0.2, {Size = UDim2.new(1, 0, 0, 0)})
            Tween(DropdownFrame, 0.2, {Size = UDim2.new(1, 0, 0, 70)})
        end
        
        task.delay(0.3, function()
            dropdownDebounce = false
        end)
    end
    
    -- Search functionality
    if SearchBox then
        SearchBox:GetPropertyChangedSignal("Text"):Connect(function()
            searchText = SearchBox.Text
            CreateItems()
            
            local contentHeight = CalculateContentHeight()
            ItemsContainer.Size = UDim2.new(1, 0, 0, contentHeight)
            DropdownFrame.Size = UDim2.new(1, 0, 0, 70 + contentHeight)
        end)
    end
    
    HeaderButton.MouseButton1Click:Connect(ToggleDropdown)
    
    CreateItems()
    UpdateDisplayText()
    
    -- Return functions
    local Functions = {}
    
    function Functions:Refresh(newItems)
        if not newItems or type(newItems) ~= "table" then return self end
        
        items = newItems
        showSearch = #items > 5
        
        -- If expanded, close without toggling
        if isExpanded then
            isExpanded = false
            dropdownDebounce = true
            
            ArrowIcon.Rotation = 90
            ItemsContainer.Size = UDim2.new(1, 0, 0, 0)
            DropdownFrame.Size = UDim2.new(1, 0, 0, 70)
            
            task.delay(0.1, function()
                dropdownDebounce = false
            end)
        end
        
        if SearchContainer then
            SearchContainer.Visible = showSearch
            ItemsScrollFrame.Position = showSearch and UDim2.new(0, 0, 0, 35) or UDim2.new(0, 0, 0, 0)
            ItemsScrollFrame.Size = showSearch and UDim2.new(1, 0, 1, -35) or UDim2.new(1, 0, 1, 0)
        end
        
        local validSelections = {}
        for item, selected in pairs(selectedItems) do
            if selected then
                for _, newItem in ipairs(items) do
                    if newItem == item then
                        validSelections[item] = true
                        break
                    end
                end
            end
        end
        selectedItems = validSelections
        
        CreateItems()
        UpdateDisplayText()
        
        return self
    end
    
    function Functions:GetValue()
        local selectedNames = {}
        for item, selected in pairs(selectedItems) do
            if selected then
                table.insert(selectedNames, item)
            end
        end
        return selectedNames
    end
    
    function Functions:Set(itemsToSelect)
        if type(itemsToSelect) == "string" then
            itemsToSelect = {itemsToSelect}
        end
        
        selectedItems = {}
        
        if itemsToSelect then
            for _, item in ipairs(itemsToSelect) do
                for _, existingItem in ipairs(items) do
                    if existingItem == item then
                        selectedItems[item] = true
                        break
                    end
                end
            end
        end
        
        CreateItems()
        UpdateDisplayText()
        return self
    end
    
    function Functions:Clear()
        selectedItems = {}
        CreateItems()
        UpdateDisplayText()
        return self
    end
    
    library.Flags[flag] = Functions
    return Functions
end

--============================================--
--             SECTION CREATOR                --
--============================================--

local function CreateSection(container, sectionName, library)
    local SectionFrame = Create("Frame", {
        Name = sectionName .. "Section",
        Parent = container,
        BackgroundColor3 = Color3.fromRGB(30, 30, 35),
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 35),
        AutomaticSize = Enum.AutomaticSize.Y
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 6),
        Parent = SectionFrame
    })
    
    Create("UIStroke", {
        Parent = SectionFrame,
        Color = Color3.fromRGB(255, 255, 255),
        Thickness = 1,
        Transparency = 0.6
    })
    
    local SectionTitle = Create("TextLabel", {
        Name = "Title",
        Parent = SectionFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 10, 0, 0),
        Size = UDim2.new(1, -30, 0, 35),
        Font = Enum.Font.GothamBold,
        Text = sectionName,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd
    })
    
    local DropArrow = Create("ImageLabel", {
        Name = "DropArrow",
        Parent = SectionFrame, -- Parent to frame instead of title
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -30, 0, 12),
        Size = UDim2.new(0, 10, 0, 10),
        Image = "rbxassetid://6031094670",
        ImageColor3 = Color3.fromRGB(255, 255, 255),
        Rotation = -90,
        ZIndex = 2
    })
    
    -- Create a dedicated clickable button for section toggle (only in header area)
    local SectionToggleButton = Create("TextButton", {
        Name = "ToggleButton",
        Parent = SectionFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 0, 0, 0),
        Size = UDim2.new(1, 0, 0, 35),
        Text = "",
        ZIndex = 1
    })
    
    local ContentFrame = Create("Frame", {
        Name = "Content",
        Parent = SectionFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 0, 0, 35),
        Size = UDim2.new(1, 0, 0, 0),
        ClipsDescendants = false,
        AutomaticSize = Enum.AutomaticSize.Y,
        ZIndex = 3 -- Higher Z so content is above toggle button
    })
    
    Create("UIPadding", {
        Parent = ContentFrame,
        PaddingLeft = UDim.new(0, 10),
        PaddingRight = UDim.new(0, 10),
        PaddingBottom = UDim.new(0, 10)
    })
    
    Create("UIListLayout", {
        Parent = ContentFrame,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 8)
    })
    
    -- Toggle section visibility - use button click instead of InputBegan
    local expanded = true
    local sectionDebounce = Debounce(0.3)
    SectionToggleButton.MouseButton1Click:Connect(function()
        sectionDebounce(function()
            expanded = not expanded
            ContentFrame.Visible = expanded
            Tween(DropArrow, 0.2, {Rotation = expanded and -90 or 90})
        end)
    end)
    
    -- Section methods
    local Section = {}
    
    function Section:AddToggle(options)
        return Components.CreateToggle(ContentFrame, options, library)
    end
    
    function Section:AddSlider(options)
        return Components.CreateSlider(ContentFrame, options, library)
    end
    
    function Section:AddButton(options)
        return Components.CreateButton(ContentFrame, options, library)
    end
    
    function Section:AddRectButton(options)
        return Components.CreateRectButton(ContentFrame, options, library)
    end
    
    function Section:AddInputLetterAdd(options)
        return Components.CreateInputLetterAdd(ContentFrame, options, library)
    end
    
    function Section:AddInput(options)
        return Components.CreateInput(ContentFrame, options, library)
    end
    
    function Section:AddDropdown(options)
        return Components.CreateDropdown(ContentFrame, options, library)
    end
    
    function Section:AddInputMultiDropdown(options)
        return Components.CreateInputMultiDropdown(ContentFrame, options, library)
    end
    
    return Section
end

--============================================--
--            SAVE MANAGER                    --
--============================================--

local DefaultConfigName = "default_" .. GameName

local SaveManager = {
    Folder = "NytheraV3/Configs",
    ConfigList = {},
    CurrentConfig = DefaultConfigName,
    SelectedConfig = DefaultConfigName,
    LastSelectedConfig = DefaultConfigName,
    ConfigurationSaving = {
        Enabled = true,
        AutoSave = true
    }
}

function SaveManager:SetupFolders()
    -- Need to create parent folder first, then subfolder
    local parentFolder = "NytheraV3"
    local configFolder = "NytheraV3/Configs"
    
    local success1 = pcall(function()
        if not isfolder(parentFolder) then
            makefolder(parentFolder)
        end
    end)
    
    local success2 = pcall(function()
        if not isfolder(configFolder) then
            makefolder(configFolder)
        end
    end)
    
    return success1 and success2
end

function SaveManager:RefreshConfigList()
    local configs = {DefaultConfigName}
    
    local success = pcall(function()
        self:SetupFolders()
        
        local folderExists = isfolder(self.Folder)
        
        if not folderExists then
            return
        end
        
        local files = listfiles(self.Folder)
        
        local hasDefault = false
        configs = {}
        
        for _, file in ipairs(files) do
            local fileName = string.match(file, "[^/\\]+$")
            
            if fileName and string.match(fileName, "%.json$") then
                fileName = string.gsub(fileName, "%.json$", "")
                -- Only include configs for current game or configs without gameId
                local configGameId = self:GetConfigGameId(fileName)
                if configGameId == nil or configGameId == GameId then
                    table.insert(configs, fileName)
                    if fileName == DefaultConfigName then hasDefault = true end
                end
            end
        end
        
        if not hasDefault then
            table.insert(configs, 1, DefaultConfigName)
        end
    end)
    
    if not success then
        configs = {DefaultConfigName}
    end
    
    self.ConfigList = configs
    return configs
end

function SaveManager:GetConfigGameId(configName)
    local success, result = pcall(function()
        local filePath = self.Folder .. "/" .. configName .. ".json"
        if not isfile(filePath) then return nil end
        
        local content = readfile(filePath)
        local data = HttpService:JSONDecode(content)
        return data._gameId
    end)
    
    return success and result or nil
end

function SaveManager:SaveConfig(configName, library)
    
    if not self.ConfigurationSaving.Enabled then
        library:NotifyError("Config saving disabled!")
        return false
    end
    
    configName = configName or DefaultConfigName
    configName = CleanString(configName)
    
    if configName == "" then
        library:NotifyError("Invalid config name!")
        return false
    end
    
    -- Setup folders first
    local folderSuccess = self:SetupFolders()
    
    -- Build config data
    local configTable = {_gameId = GameId}
    local flagCount = 0
    
    for flag, element in pairs(library.Flags) do
        -- Skip internal flags starting with underscore
        if not flag:match("^_") then
            local success, value = pcall(function()
                if element and element.GetValue then
                    return element:GetValue()
                end
                return nil
            end)
            
            if success and value ~= nil then
                configTable[flag] = value
                flagCount = flagCount + 1
            end
        end
    end
    
    
    -- Write the file
    local filePath = self.Folder .. "/" .. configName .. ".json"
    
    local jsonSuccess, jsonData = pcall(function()
        return HttpService:JSONEncode(configTable)
    end)
    
    if not jsonSuccess then
        library:NotifyError("Failed to encode config!")
        return false
    end
    
    
    local writeSuccess, writeErr = pcall(function()
        writefile(filePath, jsonData)
    end)
    
    if not writeSuccess then
        library:NotifyError("Failed to write file!")
        return false
    end
    
    -- Verify the file was written
    local verifySuccess, exists = pcall(function()
        return isfile(filePath)
    end)
    
    
    if verifySuccess and exists then
        self.CurrentConfig = configName
        library:NotifySuccess("Saved: " .. configName)
        return true
    else
        library:NotifyError("File verification failed!")
        return false
    end
end

function SaveManager:LoadConfig(configName, library)
    
    if not self.ConfigurationSaving.Enabled then
        library:NotifyError("Config loading disabled!")
        return false
    end
    
    configName = configName or DefaultConfigName
    local filePath = self.Folder .. "/" .. configName .. ".json"
    
    -- Check if file exists first
    local fileExists = false
    local existsSuccess, existsErr = pcall(function()
        fileExists = isfile(filePath)
    end)
    
    
    if not existsSuccess then
        library:NotifyError("Cannot check file!")
        return false
    end
    
    if not fileExists then
        library:NotifyWarning("Config not found: " .. configName)
        return false
    end
    
    -- Read the file
    local readSuccess, content = pcall(function()
        return readfile(filePath)
    end)
    
    if not readSuccess then
        library:NotifyError("Failed to read file!")
        return false
    end
    
    
    -- Parse JSON
    local parseSuccess, result = pcall(function()
        return HttpService:JSONDecode(content)
    end)
    
    if not parseSuccess then
        library:NotifyError("Invalid config format!")
        return false
    end
    
    -- Check game ID
    if result._gameId and result._gameId ~= GameId then
        library:NotifyWarning("Config from different game!")
        return false
    end
    
    -- Apply settings
    local loadedCount = 0
    for flag, value in pairs(result) do
        if flag ~= "_gameId" and library.Flags[flag] then
            local loadSuccess = pcall(function()
                if library.Flags[flag].Set then
                    library.Flags[flag]:Set(value)
                    loadedCount = loadedCount + 1
                end
            end)
        end
    end
    
    
    self.CurrentConfig = configName
    library:NotifySuccess("Loaded: " .. configName .. " (" .. loadedCount .. ")")
    return true
end

function SaveManager:DeleteConfig(configName, library)
    if not configName or configName == "" then
        library:NotifyError("Invalid config name!")
        return
    end
    
    if configName == DefaultConfigName then
        library:NotifyError("Cannot delete default!")
        return
    end
    
    local filePath = self.Folder .. "/" .. configName .. ".json"
    
    if isfile(filePath) then
        local success = pcall(function()
            delfile(filePath)
        end)
        
        if success then
            library:NotifySuccess("Config deleted!")
            if self.CurrentConfig == configName then
                self.CurrentConfig = DefaultConfigName
            end
        else
            library:NotifyError("Failed to delete!")
        end
    else
        library:NotifyWarning("Config not found!")
    end
end

function SaveManager:SaveLastSelectedConfig()
    pcall(function()
        self:SetupFolders()
        writefile(self.Folder .. "/_last_selected_" .. GameId .. ".txt", self.LastSelectedConfig)
    end)
end

function SaveManager:LoadLastSelectedConfig()
    local success, result = pcall(function()
        local path = self.Folder .. "/_last_selected_" .. GameId .. ".txt"
        if isfile(path) then
            local content = readfile(path)
            if content and content ~= "" then
                return content:gsub("%s+", "")
            end
        end
        return DefaultConfigName
    end)
    
    self.LastSelectedConfig = success and result or DefaultConfigName
    self.SelectedConfig = self.LastSelectedConfig
    self.CurrentConfig = self.LastSelectedConfig
end

function SaveManager:BuildConfigSection(tab, library)
    self:SetupFolders()
    self:LoadLastSelectedConfig()
    
    local configList = self:RefreshConfigList()
    local ConfigSection = tab:AddSection("Configuration", "left")
    
    local configNameInput = self.LastSelectedConfig
    
    local ConfigNameInput = ConfigSection:AddInputLetterAdd({
        Name = "Config Name",
        Default = self.LastSelectedConfig,
        PlaceholderText = "Enter config name...",
        MaxLength = 30,
        Callback = function(text)
            configNameInput = text
        end,
        Flag = "_config_name_input"
    })
    
    local ConfigDropdown = ConfigSection:AddDropdown({
        Name = "Select Config",
        Items = configList,
        MultiSelect = false,
        AutoClose = false,
        DefaultSelections = {self.LastSelectedConfig},
        Callback = function(selected)
            if selected and selected ~= "" then
                self.SelectedConfig = selected
                self.LastSelectedConfig = selected
                self:SaveLastSelectedConfig()
                ConfigNameInput:Set(selected)
                configNameInput = selected
            end
        end,
        Flag = "_config_selector"
    })
    
    ConfigSection:AddButton({
        Name = "Save Config",
        Callback = function()
            if not configNameInput or configNameInput == "" or configNameInput:match("^%s*$") then
                library:NotifyError("Enter a valid name!")
                return
            end
            
            self:SaveConfig(configNameInput, library)
            self.LastSelectedConfig = configNameInput
            self:SaveLastSelectedConfig()
            
            task.wait(0.1)
            local newList = self:RefreshConfigList()
            ConfigDropdown:Refresh(newList)
            ConfigDropdown:Set(configNameInput)
        end
    })
    
    ConfigSection:AddButton({
        Name = "Load Config",
        Callback = function()
            if self.SelectedConfig and self.SelectedConfig ~= "" then
                self:LoadConfig(self.SelectedConfig, library)
            else
                library:NotifyError("Select a config!")
            end
        end
    })
    
    ConfigSection:AddButton({
        Name = "Delete Config",
        Callback = function()
            if not self.SelectedConfig or self.SelectedConfig == "" then
                library:NotifyError("Select a config!")
                return
            end
            
            if self.SelectedConfig == DefaultConfigName then
                library:NotifyError("Cannot delete default!")
                return
            end
            
            self:DeleteConfig(self.SelectedConfig, library)
            
            self.SelectedConfig = DefaultConfigName
            self.LastSelectedConfig = DefaultConfigName
            self:SaveLastSelectedConfig()
            ConfigDropdown:Set(DefaultConfigName)
            ConfigNameInput:Set(DefaultConfigName)
            
            task.wait(0.1)
            local newList = self:RefreshConfigList()
            ConfigDropdown:Refresh(newList)
        end
    })
    
    ConfigSection:AddButton({
        Name = "Refresh List",
        Callback = function()
            local newList = self:RefreshConfigList()
            ConfigDropdown:Refresh(newList)
            library:NotifySuccess("List refreshed!")
        end
    })
    
    local SettingsSection = tab:AddSection("Settings", "right")
    
    SettingsSection:AddToggle({
        Name = "Auto Save",
        Default = self.ConfigurationSaving.AutoSave,
        Callback = function(value)
            self.ConfigurationSaving.AutoSave = value
            if value then
                library:NotifySuccess("Auto-save enabled")
            else
                library:NotifyWarning("Auto-save disabled")
            end
        end,
        Flag = "_auto_save_toggle"
    })
    
    SettingsSection:AddToggle({
        Name = "Hide Notifications",
        Default = library.Settings.HideNotifications,
        Callback = function(value)
            library.Settings.HideNotifications = value
        end,
        Flag = "_hide_notifications"
    })
    
    return ConfigSection
end

function SaveManager:AutoSaveLoop(library)
    -- Don't auto-save until initial config has been loaded
    if not self._initialConfigLoaded then
        return
    end
    
    if self.ConfigurationSaving.Enabled and self.ConfigurationSaving.AutoSave then
        self:SaveConfig(self.LastSelectedConfig or DefaultConfigName, library)
    end
end

-- Auto-load the last selected config on startup
function SaveManager:AutoLoadConfig(library)
    self:SetupFolders()
    self:LoadLastSelectedConfig()
    
    local configName = self.LastSelectedConfig or DefaultConfigName
    local filePath = self.Folder .. "/" .. configName .. ".json"
    
    -- Check if file exists
    local fileExists = false
    pcall(function()
        fileExists = isfile(filePath)
    end)
    
    if fileExists then
        self:LoadConfig(configName, library)
    end
    
    -- Mark initial config as loaded - now auto-save can run
    self._initialConfigLoaded = true
end

Library.SaveManager = SaveManager

--============================================--
--            WINDOW CREATOR                  --
--============================================--

function Library:CreateWindow()
    -- Cleanup existing connections
    if Library._activeConnections then
        for _, conn in pairs(Library._activeConnections) do
            if conn then pcall(function() conn:Disconnect() end) end
        end
    end
    Library._activeConnections = {}
    
    -- Cleanup existing UI
    if CoreGui:FindFirstChild("NytheraV3") then
        CoreGui:FindFirstChild("NytheraV3"):Destroy()
    end
    if CoreGui:FindFirstChild("NytheraV3_MobileButton") then
        CoreGui:FindFirstChild("NytheraV3_MobileButton"):Destroy()
    end
    
    local NytheraV3 = Create("ScreenGui", {
        Name = "NytheraV3",
        Parent = CoreGui,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    })
    
    local Main = Create("Frame", {
        Name = "Main",
        Parent = NytheraV3,
        BackgroundColor3 = Color3.fromRGB(25, 25, 30),
        BorderSizePixel = 0,
        Position = UDim2.new(0.5, -350, 0.5, -225),
        Size = UDim2.new(0, 750, 0, 450),
        ClipsDescendants = true
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 6),
        Parent = Main
    })
    
    -- Initialize notification system
    NotificationManager:Initialize(Main)
    
    -- Top Bar
    local TopBar = Create("Frame", {
        Name = "TopBar",
        Parent = Main,
        BackgroundColor3 = Color3.fromRGB(30, 30, 35),
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 30)
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 6),
        Parent = TopBar
    })
    
    Create("Frame", {
        Name = "BottomCover",
        Parent = TopBar,
        BackgroundColor3 = Color3.fromRGB(30, 30, 35),
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 1, -6),
        Size = UDim2.new(1, 0, 0, 6)
    })
    
    Create("ImageLabel", {
        Name = "Logo",
        Parent = TopBar,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 8),
        Size = UDim2.new(0, 16, 0, 16),
        Image = "rbxassetid://93130318067251",
        ImageColor3 = Color3.fromRGB(255, 255, 255)
    })
    
    Create("TextLabel", {
        Name = "Title",
        Parent = TopBar,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 0, 0, 0),
        Size = UDim2.new(0, 150, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = "Nythera V3",
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Center
    })
    
    local TabNameText = Create("TextLabel", {
        Name = "TabNameText",
        Parent = TopBar,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 160, 0, 0),
        Size = UDim2.new(1, -170, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = "",
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd
    })
    
    local MinimizeButton = Create("TextButton", {
        Name = "MinimizeButton",
        Parent = TopBar,
        BackgroundColor3 = Color3.fromRGB(40, 40, 45),
        BorderSizePixel = 0,
        Position = UDim2.new(1, -25, 0.5, -10),
        Size = UDim2.new(0, 20, 0, 20),
        Font = Enum.Font.GothamBold,
        Text = "-",
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 16,
        ZIndex = 10,
        AutoButtonColor = false
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 4),
        Parent = MinimizeButton
    })
    
    -- Mobile Button
    local MobileButtonGui = Create("ScreenGui", {
        Name = "NytheraV3_MobileButton",
        Parent = CoreGui,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
        ResetOnSpawn = false
    })
    
    local MobileCloseButton = Create("TextButton", {
        Name = "MobileCloseButton",
        Parent = MobileButtonGui,
        BackgroundColor3 = Color3.fromRGB(40, 40, 45),
        BorderSizePixel = 0,
        Position = UDim2.new(0, 20, 0, 20),
        Size = UDim2.new(0, 50, 0, 50),
        Text = "",
        ZIndex = 15,
        AutoButtonColor = false
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = MobileCloseButton
    })
    
    Create("ImageLabel", {
        Name = "CloseIcon",
        Parent = MobileCloseButton,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 10, 0, 10),
        Size = UDim2.new(0, 30, 0, 30),
        Image = "rbxassetid://93130318067251",
        ImageColor3 = Color3.fromRGB(255, 255, 255),
        ZIndex = 16
    })
    
    -- Sidebar
    local Sidebar = Create("Frame", {
        Name = "Sidebar",
        Parent = Main,
        BackgroundColor3 = Color3.fromRGB(30, 30, 35),
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 0, 30),
        Size = UDim2.new(0, 150, 1, -30)
    })
    
    -- User Profile
    local UserProfile = Create("Frame", {
        Name = "UserProfile",
        Parent = Sidebar,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 50)
    })
    
    local Avatar = Create("ImageLabel", {
        Name = "Avatar",
        Parent = UserProfile,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 10, 0.5, -15),
        Size = UDim2.new(0, 30, 0, 30),
        Image = "rbxasset://textures/ui/GuiImagePlaceholder.png"
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0.5, 0),
        Parent = Avatar
    })
    
    Create("TextLabel", {
        Name = "Username",
        Parent = UserProfile,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 50, 0, 0),
        Size = UDim2.new(1, -60, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = LocalPlayer.Name,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 12,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd
    })
    
    Create("Frame", {
        Name = "Separator",
        Parent = Sidebar,
        BackgroundColor3 = Color3.fromRGB(45, 45, 50),
        BorderSizePixel = 0,
        Position = UDim2.new(0, 10, 0, 50),
        Size = UDim2.new(1, -20, 0, 1)
    })
    
    -- Load avatar
    task.spawn(function()
        local success, result = pcall(function()
            return Players:GetUserThumbnailAsync(LocalPlayer.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size420x420)
        end)
        if success and result then
            Avatar.Image = result
        end
    end)
    
    local TabButtons = Create("ScrollingFrame", {
        Name = "TabButtons",
        Parent = Sidebar,
        Active = true,
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 0, 55),
        Size = UDim2.new(1, 0, 1, -55),
        CanvasSize = UDim2.new(0, 0, 0, 0),
        ScrollBarThickness = 0,
        AutomaticCanvasSize = Enum.AutomaticSize.Y
    })
    
    Create("UIListLayout", {
        Parent = TabButtons,
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 5)
    })
    
    Create("UIPadding", {
        Parent = TabButtons,
        PaddingTop = UDim.new(0, 10)
    })
    
    local ContentContainer = Create("Frame", {
        Name = "ContentContainer",
        Parent = Main,
        BackgroundColor3 = Color3.fromRGB(25, 25, 30),
        BorderSizePixel = 0,
        Position = UDim2.new(0, 150, 0, 30),
        Size = UDim2.new(1, -150, 1, -30),
        ClipsDescendants = true
    })
    
    -- Resize Handle
    local ResizeHandle = Create("TextButton", {
        Name = "ResizeHandle",
        Parent = Main,
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -20, 1, -20),
        Size = UDim2.new(0, 20, 0, 20),
        Text = "",
        ZIndex = 10
    })
    
    local ResizeGrid = Create("Frame", {
        Parent = ResizeHandle,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0)
    })
    
    for i = 1, 6 do
        Create("Frame", {
            Parent = ResizeGrid,
            BackgroundColor3 = Color3.fromRGB(255, 255, 255),
            BackgroundTransparency = 0.6,
            BorderSizePixel = 0,
            Position = UDim2.new(0, ((i-1) % 3) * 6, 0, math.floor((i-1) / 3) * 6),
            Size = UDim2.new(0, 2, 0, 2)
        })
    end
    
    -- State tracking
    local Tabs = {}
    local ActiveTab = nil
    local isMinimized = false
    local originalSize = Main.Size
    local isUIVisible = true
    
    -- Simple dragging functionality (no boundary constraints)
    local function SetupDragging(element, target)
        local dragging = false
        local dragStart, startPos
        local dragConnection
        
        element.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging = true
                dragStart = input.Position
                startPos = target.Position
                
                if dragConnection then dragConnection:Disconnect() end
                dragConnection = UserInputService.InputChanged:Connect(function(changed)
                    if dragging and (changed.UserInputType == Enum.UserInputType.MouseMovement or changed.UserInputType == Enum.UserInputType.Touch) then
                        local delta = changed.Position - dragStart
                        target.Position = UDim2.new(
                            startPos.X.Scale, startPos.X.Offset + delta.X,
                            startPos.Y.Scale, startPos.Y.Offset + delta.Y
                        )
                    end
                end)
                Library._activeConnections.drag = dragConnection
            end
        end)
        
        element.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging = false
                if dragConnection then dragConnection:Disconnect() end
                Library._activeConnections.drag = nil
            end
        end)
    end
    
    SetupDragging(TopBar, Main)
    
    -- Mobile button dragging and toggle
    local mobileButtonDragging = false
    local mobileDragStart, mobileStartPos
    local mobileDragConnection
    
    MobileCloseButton.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            mobileButtonDragging = true
            mobileDragStart = input.Position
            mobileStartPos = MobileCloseButton.Position
            
            if mobileDragConnection then mobileDragConnection:Disconnect() end
            mobileDragConnection = UserInputService.InputChanged:Connect(function(changed)
                if mobileButtonDragging and (changed.UserInputType == Enum.UserInputType.MouseMovement or changed.UserInputType == Enum.UserInputType.Touch) then
                    local delta = changed.Position - mobileDragStart
                    MobileCloseButton.Position = UDim2.new(
                        mobileStartPos.X.Scale, mobileStartPos.X.Offset + delta.X,
                        mobileStartPos.Y.Scale, mobileStartPos.Y.Offset + delta.Y
                    )
                end
            end)
            Library._activeConnections.mobileDrag = mobileDragConnection
        end
    end)
    
    MobileCloseButton.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            if mobileButtonDragging and mobileDragStart then
                local dragDistance = (input.Position - mobileDragStart).Magnitude
                if dragDistance < 10 then
                    isUIVisible = not isUIVisible
                    NytheraV3.Enabled = isUIVisible
                    
                    local icon = MobileCloseButton:FindFirstChild("CloseIcon")
                    if isUIVisible then
                        icon.ImageColor3 = Color3.fromRGB(255, 100, 100)
                        MobileCloseButton.BackgroundColor3 = Color3.fromRGB(60, 40, 40)
                    else
                        icon.ImageColor3 = Color3.fromRGB(100, 255, 100)
                        MobileCloseButton.BackgroundColor3 = Color3.fromRGB(40, 60, 40)
                    end
                end
            end
            mobileButtonDragging = false
            if mobileDragConnection then mobileDragConnection:Disconnect() end
            Library._activeConnections.mobileDrag = nil
        end
    end)
    
    -- Resizing functionality
    local resizing = false
    local minSize = Vector2.new(750, 450)
    local mouseOffset = Vector2.new(0, 0)
    local resizeConnection
    
    ResizeHandle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            local framePos = Main.AbsolutePosition
            local frameSize = Main.AbsoluteSize
            mouseOffset = Vector2.new((framePos.X + frameSize.X) - input.Position.X, (framePos.Y + frameSize.Y) - input.Position.Y)
            resizing = true
            
            if resizeConnection then resizeConnection:Disconnect() end
            resizeConnection = UserInputService.InputChanged:Connect(function(changed)
                if resizing and (changed.UserInputType == Enum.UserInputType.MouseMovement or changed.UserInputType == Enum.UserInputType.Touch) then
                    local width = math.max((changed.Position.X + mouseOffset.X) - Main.AbsolutePosition.X, minSize.X)
                    local height = math.max((changed.Position.Y + mouseOffset.Y) - Main.AbsolutePosition.Y, minSize.Y)
                    Main.Size = UDim2.new(0, width, 0, height)
                end
            end)
            Library._activeConnections.resize = resizeConnection
        end
    end)
    
    ResizeHandle.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            resizing = false
            if resizeConnection then resizeConnection:Disconnect() end
            Library._activeConnections.resize = nil
        end
    end)
    
    -- Minimize functionality
    local minimizeDebounce = Debounce(0.5)
    MinimizeButton.MouseButton1Click:Connect(function()
        minimizeDebounce(function()
            isMinimized = not isMinimized
            
            if isMinimized then
                originalSize = Main.Size
                Tween(Main, 0.3, {Size = UDim2.new(originalSize.X.Scale, originalSize.X.Offset, 0, 30)}, Enum.EasingStyle.Quart)
                Sidebar.Visible = false
                ContentContainer.Visible = false
                ResizeHandle.Visible = false
                MinimizeButton.Text = "+"
            else
                Tween(Main, 0.3, {Size = originalSize}, Enum.EasingStyle.Quart)
                task.wait(0.1)
                Sidebar.Visible = true
                ContentContainer.Visible = true
                ResizeHandle.Visible = true
                MinimizeButton.Text = "-"
            end
        end)
    end)
    
    MinimizeButton.MouseEnter:Connect(function()
        Tween(MinimizeButton, 0.2, {BackgroundColor3 = Color3.fromRGB(60, 60, 65)})
    end)
    
    MinimizeButton.MouseLeave:Connect(function()
        Tween(MinimizeButton, 0.2, {BackgroundColor3 = Color3.fromRGB(40, 40, 45)})
    end)
    
    -- Window object
    local Window = {}
    local tabOrder = 0
    local configTabCreated = false
    
    function Window:CreateTab(name, icon)
        tabOrder = tabOrder + 1
        
        local TabButton = Create("TextButton", {
            Name = name .. "Button",
            Parent = TabButtons,
            BackgroundColor3 = Color3.fromRGB(35, 35, 40),
            BorderSizePixel = 0,
            Size = UDim2.new(0.9, 0, 0, 35),
            Text = "",
            AutoButtonColor = false,
            LayoutOrder = tabOrder
        })
        
        Create("UICorner", {
            CornerRadius = UDim.new(0, 6),
            Parent = TabButton
        })
        
        Create("ImageLabel", {
            Name = "Icon",
            Parent = TabButton,
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 10, 0.5, -10),
            Size = UDim2.new(0, 20, 0, 20),
            Image = icon or "rbxassetid://7072706318",
            ImageColor3 = Color3.fromRGB(255, 255, 255)
        })
        
        Create("TextLabel", {
            Name = "Name",
            Parent = TabButton,
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 40, 0, 0),
            Size = UDim2.new(1, -45, 1, 0),
            Font = Enum.Font.Gotham,
            Text = name,
            TextColor3 = Color3.fromRGB(255, 255, 255),
            TextSize = 14,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextTruncate = Enum.TextTruncate.AtEnd
        })
        
        local TabPage = Create("ScrollingFrame", {
            Name = name .. "Page",
            Parent = ContentContainer,
            Active = true,
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
            Size = UDim2.new(1, 0, 1, 0),
            CanvasSize = UDim2.new(0, 0, 0, 0),
            ScrollBarThickness = 3,
            ScrollBarImageColor3 = Color3.fromRGB(70, 70, 80),
            Visible = false,
            AutomaticCanvasSize = Enum.AutomaticSize.Y
        })
        
        local LeftContainer = Create("Frame", {
            Name = "LeftContainer",
            Parent = TabPage,
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 10, 0, 10),
            Size = UDim2.new(0.5, -15, 0, 0),
            AutomaticSize = Enum.AutomaticSize.Y
        })
        
        Create("UIListLayout", {
            Parent = LeftContainer,
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 10)
        })
        
        local RightContainer = Create("Frame", {
            Name = "RightContainer",
            Parent = TabPage,
            BackgroundTransparency = 1,
            Position = UDim2.new(0.5, 5, 0, 10),
            Size = UDim2.new(0.5, -15, 0, 0),
            AutomaticSize = Enum.AutomaticSize.Y
        })
        
        Create("UIListLayout", {
            Parent = RightContainer,
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 10)
        })
        
        local function handleTabClick()
            if ActiveTab ~= TabPage then
                if ActiveTab then ActiveTab.Visible = false end
                TabPage.Visible = true
                ActiveTab = TabPage
                TabNameText.Text = name
                
                for _, tab in pairs(Tabs) do
                    if tab.Button == TabButton then
                        Tween(tab.Button, 0.2, {BackgroundColor3 = Color3.fromRGB(50, 50, 60)})
                    else
                        Tween(tab.Button, 0.2, {BackgroundColor3 = Color3.fromRGB(35, 35, 40)})
                    end
                end
            end
        end
        
        TabButton.MouseButton1Click:Connect(handleTabClick)
        
        TabButton.MouseEnter:Connect(function()
            if ActiveTab ~= TabPage then
                Tween(TabButton, 0.2, {BackgroundColor3 = Color3.fromRGB(40, 40, 50)})
            end
        end)
        
        TabButton.MouseLeave:Connect(function()
            if ActiveTab ~= TabPage then
                Tween(TabButton, 0.2, {BackgroundColor3 = Color3.fromRGB(35, 35, 40)})
            end
        end)
        
        local Tab = {
            Button = TabButton,
            Page = TabPage,
            LeftContainer = LeftContainer,
            RightContainer = RightContainer
        }
        
        table.insert(Tabs, Tab)
        
        if #Tabs == 1 then
            TabButton.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
            TabPage.Visible = true
            ActiveTab = TabPage
            TabNameText.Text = name
        end
        
        function Tab:AddSection(sectionName, side)
            side = side or "left"
            local container = (side:lower() == "left") and LeftContainer or RightContainer
            return CreateSection(container, sectionName, Library)
        end
        
        return Tab
    end
    
    -- Auto-create Config tab
    function Window:CreateConfigTab()
        if configTabCreated then return end
        configTabCreated = true
        
        local ConfigTab = self:CreateTab("Config", "rbxassetid://7072706320")
        -- Move config tab to last position
        ConfigTab.Button.LayoutOrder = 9999
        
        SaveManager:BuildConfigSection(ConfigTab, Library)
    end
    
    -- Auto-save loop (disconnect old connection if exists)
    if Library._heartbeatConnection then
        Library._heartbeatConnection:Disconnect()
    end
    
    -- Reset the initial config loaded flag
    SaveManager._initialConfigLoaded = false
    
    local lastSaveTime = tick()
    Library._heartbeatConnection = RunService.Heartbeat:Connect(function()
        if tick() - lastSaveTime >= 60 then
            lastSaveTime = tick()
            SaveManager:AutoSaveLoop(Library)
        end
    end)
    
    -- Create config tab and auto-load saved config
    task.defer(function()
        Window:CreateConfigTab()
        
        -- Wait a moment for UI to be ready, then auto-load config
        task.wait(0.5)
        SaveManager:AutoLoadConfig(Library)
    end)
    
    return Window
end

--============================================--
--            LIBRARY EXPORT                  --
--============================================--

getgenv().NytheraV3 = Library
return Library

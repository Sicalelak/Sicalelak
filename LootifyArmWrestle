local Library
local success, err = pcall(function()
    Library = loadstring(
        game:HttpGet(
            'https://raw.githubusercontent.com/Sicalelak/Sicalelak/refs/heads/main/NytheraRevampUI'
        )
    )()
end)

if not success or not Library then
    error('Failed to load Nythera V3 Library: ' .. (err or 'Unknown error'))
    return
end

if not Library or not Library.Config then
    error('Library loaded but Config is missing - check your library code')
    return
end

Library.Config.AccentColor = Color3.fromRGB(255, 85, 85)

local Window = Library:CreateWindow()

local game = game
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

local botEnabled = false
local autoClickConnection
local gameActive = false
local Config

local function getAbsoluteValue(num)
    if num < 0 then
        return -num
    end
    return num
end

local function loadConfig()
    local success = pcall(function()
        Config = require(ReplicatedStorage.Config.Planning.Config).ChristmasArmWrestlConfig
    end)
    return success and Config ~= nil
end

local function findAndMonitorUI()
    spawn(function()
        while true do
            wait(0.5)
            
            local success = pcall(function()
                local playerGui = LocalPlayer.PlayerGui
                local main = playerGui:FindFirstChild("Main")
                if not main then return end
                
                local func = main:FindFirstChild("Func")
                if not func then return end
                
                local armwrestling = func:FindFirstChild("Armwrestling")
                if not armwrestling then 
                    gameActive = false
                    return 
                end
                
                local bar = armwrestling:FindFirstChild("Bar")
                if not bar then return end
                
                local judgmentline = bar:FindFirstChild("Judgmentline")
                local successArea = bar:FindFirstChild("SuccessArea")
                
                if judgmentline and successArea then
                    if not gameActive then
                        gameActive = true
                    end
                end
            end)
        end
    end)
end

local function getUIPositions()
    local positions = {}
    
    pcall(function()
        local playerGui = LocalPlayer.PlayerGui
        local main = playerGui:FindFirstChild("Main")
        if not main then return end
        
        local func = main:FindFirstChild("Func")
        if not func then return end
        
        local armwrestling = func:FindFirstChild("Armwrestling")
        if not armwrestling then return end
        
        local bar = armwrestling:FindFirstChild("Bar")
        if not bar then return end
        
        local judgmentline = bar:FindFirstChild("Judgmentline")
        local successArea = bar:FindFirstChild("SuccessArea")
        
        if judgmentline and successArea then
            positions.judgmentlineX = judgmentline.Position.X.Scale
            
            local successChildren = {}
            for _, child in pairs(successArea:GetChildren()) do
                if child:IsA("Frame") and child.Visible then
                    local childPos = child.Position.X.Scale
                    local childSize = child.Size.X.Scale
                    table.insert(successChildren, {
                        pos = childPos,
                        size = childSize,
                        left = childPos - childSize / 2,
                        right = childPos + childSize / 2,
                        center = childPos
                    })
                end
            end
            
            if #successChildren > 0 then
                table.sort(successChildren, function(a, b) return a.pos < b.pos end)
                local middleIndex = 1
                if #successChildren % 2 == 0 then
                    middleIndex = #successChildren / 2
                else
                    middleIndex = (#successChildren + 1) / 2
                end
                
                positions.targetX = successChildren[middleIndex].center
                positions.tolerance = successChildren[middleIndex].size / 2
                positions.valid = true
            end
        end
    end)
    
    return positions
end

local function calculatePerfectTiming()
    if not gameActive then
        return false
    end
    
    local positions = getUIPositions()
    
    if not positions.valid then
        return false
    end
    
    local distance = getAbsoluteValue(positions.judgmentlineX - positions.targetX)
    
    if distance < positions.tolerance * 0.3 then
        return true
    end
    
    return false
end

local function triggerInput()
    local success = pcall(function()
        local VirtualInputManager = game:GetService("VirtualInputManager")
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
        wait(0.05)
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
    end)
    
    if not success then
        pcall(function()
            mouse1click()
        end)
    end
end

local function startAutoClick()
    if autoClickConnection then
        autoClickConnection:Disconnect()
        autoClickConnection = nil
    end
    
    autoClickConnection = RunService.Heartbeat:Connect(function()
        if not botEnabled then 
            return 
        end
        
        if calculatePerfectTiming() then
            triggerInput()
        end
    end)
end

local function stopAutoClick()
    if autoClickConnection then
        autoClickConnection:Disconnect()
        autoClickConnection = nil
    end
end

local MainTab = Window:CreateTab('Arm Wrestling Bot', 'rbxassetid://7072706620')
local BotSection = MainTab:AddSection('Bot Control', 'left')

BotSection:AddToggle({
    Name = 'Enable Auto Perfect',
    Default = false,
    Callback = function(value)
        botEnabled = value
        
        if botEnabled then
            if not Config then
                loadConfig()
            end
            
            startAutoClick()
        else
            stopAutoClick()
        end
    end,
    Flag = 'bot_enabled',
})

loadConfig()
findAndMonitorUI()
